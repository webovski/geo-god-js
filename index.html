<head>
    <title>Test Map</title>
    <meta charset="UTF-8">
    <meta content='width=device-width, initial-scale=1' name='viewport'/>
    <link href="favicon.ico" rel="icon" type="image/x-icon">
    <link href="assets/css/leaflet.css" rel="stylesheet"/>
    <link href="assets/css/app.css" rel="stylesheet"/>
    <link href="assets/css/spinner.css" rel="stylesheet"/>
    <script src="assets/js/leaflet.js"></script>
    <script src="assets/js/jquery3.3.1.js" type='text/javascript'></script>
    <script src="assets/js/sweetalert2.js" type='text/javascript'></script>
</head>
<script src="assets/js/app.js"></script>
<div id="imap">
    <div class="app-container">
        <a class="action-buttons custom-button clear-points-btn no-select" onclick="clearPoints()">
            Очистить точки
        </a>
        <a class="action-buttons custom-button start-parsing-btn no-select" onclick="startParsing()">
            Запустить парсинг
        </a>
        <div class="user-info-container no-select">
            <div class="balance">
                <span id="user-balance" style="display: none">Ваш баланс: <b id="balance-in-dollars">$0.00000</b></span>
                <div id="balance-loader">
                    <div class="lds-dual-ring"></div>
                </div>
            </div>
        </div>
        <div class="results-container user-info-container no-select">
            <div class="dropdown">
                <span>История парсинга</span>
                <div class="dropdown-content">
                    <a class="history-item" href="#">$0.35100 - 234 - 17:29 </a>
                    <a class="history-item" href="#">$0.35100 - 234 - 17:29 </a>
                    <a class="history-item" href="#">$0.35100 - 234 - 17:29 </a>
                    <a class="history-item" href="#">$0.35100 - 234 - 17:29 </a>
                    <a class="history-item" href="#">$0.35100 - 234 - 17:29 </a>
                    <a class="history-item" href="#">$0.35100 - 234 - 17:29 </a>
                    <a class="history-item" href="#">$0.35100 - 234 - 17:29 </a>
                    <a class="history-item" href="#">$0.35100 - 234 - 17:29 </a>
                    <a class="history-item" href="#">$0.35100 - 234 - 17:29 </a>
                </div>
            </div>
        </div>
    </div>

    <div id="map"><!--map rendering--></div>
</div>
<script>

    initUser()

    function initUser() {
        const queryString = window.location.search;
        const urlParams = new URLSearchParams(queryString);
        const accessKey = urlParams.get('key')

        let requestBody = {
            route: 'init',
            access_key: accessKey
        };

        $.ajax({
            type: "POST",
            url: "https://script.google.com/macros/s/AKfycbzyc-Xff4WdfX6wpkXAfiPNjRT06x_HMdfuKza8Q1-qysGNw3iFazf5723QRqHccYzG/exec",
            traditional: true,
            redirect: "follow",
            headers: {
                "Content-Type": "text/plain;charset=utf-8",
            },
            data: JSON.stringify(requestBody),
            success: function (response) {
                if (response) {
                    dataLoaded(response.balance)
                } else {
                    dataLoaded('$0.00000')
                }
            },
            error: function () {
                dataLoaded('$0.00000')
            }
        });
    }

    function dataLoaded(balanceFromServer) {
        let loadinSpinner = document.getElementById('balance-loader')
        loadinSpinner.style.display = 'none'
        let userBalance = document.getElementById('user-balance')
        document.getElementById('balance-in-dollars').innerText = balanceFromServer
        userBalance.style.display = 'block'
    }

</script>